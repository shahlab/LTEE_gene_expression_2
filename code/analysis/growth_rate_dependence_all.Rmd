---
title: "Growth rate dependence"
output: 
  html_document:
    df_print: paged
author: "John Favate"
date: "`r Sys.time()`"
---

<style type="text/css">
.main-container {
  max-width: 1500px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r}
# Prevent printing of warnings and such in the HTML
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center")
```

```{r}
library(tidyverse)
library(readxl)
library(parallel)
library(broom)
library(patchwork)
library(ggpubr)

mut.levels <- read_csv("../../data_frames/all_data.csv") %>%
  dplyr::select(line, mutator) %>%
  arrange(mutator, line) %>%
  unique() %>%
  pull(line)

mut.colors <- c("black", rep("black", 5), rep("firebrick3", 5))
```

We're going to use data from this paper https://www.embopress.org/doi/full/10.15252/msb.20145108?download=true, specifically supplementary datasets 1 and 2, which were downloaded from that page because they were not playing nicely with wget. In the `../../data_frames/SF1-EcoMAC` folder are the expression data and the column names and rows in separate files. I'll use them to make a single dataset.
```{r}
# these are the row names
rows <- read_tsv("../../data_frames/SF1-EcoMAC/numbering_assembly-tfs-enzymes-genes.txt", col_names = c("rn", "id", "gene"))

# these are the columns
column.names <- read_delim("../../data_frames/SF1-EcoMAC/numbering_arrays-compendium.txt", col_names = c("rn", "dataset"), delim = " ") %>% 
  pull(dataset)

expr.data <- read_tsv("../../data_frames/SF1-EcoMAC/Ecoli-compendium-assembly-quantilenorm.txt", col_names = column.names) %>% 
  cbind(rows) %>% 
  select(id, gene, everything())

head(expr.data)
```

The growth rates are in a separate excel sheet.
```{r}
g.rates <- read_xlsx("../../data_frames/SF1-EcoMAC/msb145108-sup-0005-datasets2.xlsx", sheet = 2) %>% 
  arrange(`Column array (EcoMAC)`)

names(g.rates) <- str_replace_all(names(g.rates), " ", "_") %>% 
  str_remove_all(., "\\(") %>% 
  str_remove_all(., "\\)") %>% 
  str_remove(., "/") %>% 
  tolower()
```

Reshape the expression data
```{r}
expr.data2 <- expr.data %>% 
  pivot_longer(cols = where(is.numeric), names_to = "cel_file_name")

head(expr.data2)
```

We filter the data to datasets that have recorded growth rates `flag_growth == 1`
```{r}
rates.only <- g.rates %>%
  filter(flag_growth == 1) %>%
  select(
    cel_file_name,
    medium,
    treatment_value,
    treatment_conditions,
    time_min,
    growth_rate_1h
  )

rates.only
```

Add the rates and file IDs together and get rid of ones that have no identifiers or no growth rates.
```{r}
rates.expr <- right_join(expr.data2, rates.only, by = "cel_file_name")

rates.expr
```

For each gene, run a linear model to predict expression from growth rate. Adjust `mc.cores` as you please. 
```{r}
# split the data into a list where each element is the data for one gene
gene.df.list <- rates.expr %>% 
  split(.$gene)
#4189

models.new <- mclapply(gene.df.list, function(x){
  lm(value ~ growth_rate_1h, data = x) %>% 
    broom::tidy() %>% 
  filter(term == "growth_rate_1h")
}, mc.cores = 16) %>% 
  bind_rows(.id = "gene") %>% 
  rename("k12_name" = "gene")
```

Get my RNASeq fold changes
```{r}
all.data <- read_csv("../../data_frames/all_data.csv") %>% 
  filter(gene_type == "ECB") %>% 
  select(line, target_id, k12_name, ds_padj_rna, ds_log2foldchange_rna)
```

How many matches on genes names are there? Reduce the model data frame to only those genes and models that have estimates and p.values and add a q-value column (they all do). 
```{r}
length(intersect(all.data$k12_name, models$k12_name))

models.filt <- models %>% 
  filter(k12_name %in% unique(all.data$k12_name) & !is.na(estimate) & !is.na(p.value))

models.filt$qval <- p.adjust(models.filt$p.value)
```

Join the models and fold changes, add columns to denote the direction of the estimate and the line order. The result is a df where we can relate estimates to fold changes, save it.
```{r}
joined.df <- left_join(all.data, models.filt, by = "k12_name") %>% 
  mutate(model_direc = factor(sign(estimate)),
         line = factor(line, mut.levels))

head(joined.df)

write_csv(joined.df, "../../data_frames/growth_depend_df.csv")
```

### Panel A

Example models of a growth dependent and growth independent gene
```{r}
genes.ordered.by.abs.estimate <- models %>% 
  arrange(desc(abs(estimate))) %>% 
  pull(k12_name)

pa <- rates.expr %>% 
  filter(gene == genes.ordered.by.abs.estimate[1] | gene == genes.ordered.by.abs.estimate[length(genes.ordered.by.abs.estimate)]) %>% 
  ggplot(., aes(growth_rate_1h, value))+
  geom_point(size = 1)+
  geom_smooth(color = "red", method = "lm")+
  facet_wrap(~gene, ncol = 2)+
  theme_bw()+
  theme(text = element_text(size = 14),
        panel.grid = element_blank())+
  labs(x = "Growth rate",
       y = "Expression",
       title = "A")+
  stat_cor()

pa
```

### Panel B

KS test the two categories.
```{r}
ks.results <- joined.df %>%
  split(.$line) %>%
  map(function(x) {
    ks.test(x[x$model_direc == 1, ]$ds_log2foldchange_rna,
            x[x$model_direc == -1, ]$ds_log2foldchange_rna) %>%
      tidy()
  }) %>% 
  bind_rows(.id = "line") %>% 
  mutate(stars = cut(
    p.value,
    c(1, .05, .01, .001, .0001, -Inf),
    labels = c("****", "***", "**", "*", "NS")
  ))
```


Join the model values to my fold changes
```{r}
pb <- joined.df %>% 
  filter(!is.na(model_direc)) %>% 
  ggplot(., aes(line, ds_log2foldchange_rna, fill = model_direc))+
  geom_hline(aes(yintercept = 0), linetype = 5)+
  geom_boxplot(outlier.size = 1)+
  theme_bw()+
  theme(panel.grid = element_blank(),
        text = element_text(size = 14),
        axis.text.x = element_text(color = mut.colors),
        legend.position = c(.85, .2),
        legend.background = element_blank())+
  scale_fill_manual(values = c("indianred", "steelblue"), name = "Growth regulation", labels = c("Negative", "Positive"))+
  labs(x = NULL,
       y = expression(paste(log[2], "(fold-change)")),
       title = "B")+
  scale_y_continuous(breaks = seq(-15,10, 5))+
  geom_text(inherit.aes = FALSE, data = ks.results, aes(line, y = 9, label = stars))

pb
```

### Panel C

Correlation between FC and model estimate
```{r fig.width = 11, fig.height = 4.5}
sig.genes <- all.data %>% 
  filter(ds_padj_rna <= .01) %>% 
  count(target_id) %>% 
  filter(n >= 2) %>% 
  pull(target_id)

pc <- joined.df %>%
  filter(target_id %in% sig.genes) %>% 
  group_by(k12_name, estimate) %>% 
  summarise(mean_fc = mean(ds_log2foldchange_rna)) %>% 
  ggplot(., aes(mean_fc, estimate))+
  geom_point(size = 1)+
  geom_smooth(color = "red", method = "lm")+
  # facet_wrap(~line, ncol = 6)+
  theme_bw()+
  theme(text = element_text(size = 14),
        panel.grid = element_blank())+
  ggpubr::stat_cor(aes(label = ..r.label..))+
  labs(x = expression(paste(log[2], "(fold-change)")),
       y = "Model estimate",
       title = "C")

pc
```

```{r}
sapply(flg, function(x){
  joined.df %>% 
    filter(k12_name == x)
}, simplify = FALSE)
```


```{r}
flg <- c("flhC", "flhD", "flgN", "flgM", "flgA", "flgB", "flgC", "flgD", "flgE", "flgF", "flgG", "flgH", "flgI", "flgJ", "flgK", "flgL", "flhA", "flhB", "flhE", "fliC")

lapply(2:5, function(x){
  sig.genes <- all.data %>% 
  filter(ds_padj_rna <= .01) %>% 
  count(target_id) %>% 
  filter(n >= x) %>% 
  pull(target_id)

pc <- joined.df %>%
  mutate(fac = x) %>% 
  filter(target_id %in% sig.genes & !(target_id %in% flg)) %>% 
  group_by(k12_name, estimate) %>% 
  summarise(mean_fc = median(ds_log2foldchange_rna)) %>% 
  ggplot(., aes(mean_fc, estimate))+
  geom_point(size = 1)+
  geom_smooth(color = "red", method = "lm")+
  # facet_wrap(~fac)+
  theme_bw()+
  theme(text = element_text(size = 14),
        panel.grid = element_blank())+
  stat_cor(aes(label = ..r.label..))+
  labs(x = expression(paste(log[2], "(fold-change)")),
       y = "Model estimate",
       title = x)

pc
})
```


I'm not so sure about the growth rate == 1 values
```{r, fig.width = 11, fig.height = 8}
top <- (pa | pb) + plot_layout(widths = c(.4, .6))

(top / pc) + plot_layout(heights = c(.4, .6))
```

